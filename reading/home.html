<!DOCTYPE html>
<html lang="en" style="height: 100vh; width: 100%;">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Poppins:wght@500&family=Rubik:wght@500&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="./css/home.css">
  <link rel="stylesheet" href="subject.css" />
  <title>Home</title>
</head>
<style>
  .modal_subjectadd {
    position: fixed;
    height: 100%;
    z-index: 1;
    display: none;
  }

  .modal_subjectadd.open {
    display: block;
  }

  .modal {
    display: none;
    /* Hidden by default */
    position: fixed;
    /* Stay in place */
    z-index: 1;
    /* Sit on top */
    left: 0;
    top: 0;
    width: 100%;
    /* Full width */
    height: 100%;
    /* Full height */
    overflow: auto;
    /* Enable scroll if needed */
    background-color: rgba(0, 0, 0, 0.4);
    /* Black w/ opacity */
  }

  /* Modal content styles */
  .modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    /* 15% from the top and centered */
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    /* Could be more or less, depending on screen size */
  }

  /* Close button styles */
  .close {
    color: #aaaaaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }

  .close:hover,
  .close:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
  }

  .grid-container {
    display: grid;
    grid-template-columns: auto auto auto;
    padding: 10px;
    margin-top: 50px;
    height: 75%;
    overflow: scroll;
  }

  .grid-item {
    background-color: rgba(255, 255, 255, 0.8);
    padding: 7px;
    font-size: 30px;
    text-align: center;
  }

  .font {
    font-family: 'Fredoka One', cursive;
    font-family: 'Poppins', sans-serif;
    font-family: 'Rubik', sans-serif;
  }

  body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
  }

  .navbar {
    overflow: hidden;
    background-color: rgb(254, 254, 254);
    position: fixed;
    bottom: 0;
    width: 100%;
    height: 76px;
    box-shadow: 5px 5px 10px 10px rgba(85, 85, 85, 0.4);
    border-radius: 2px;
  }

  .navbar a {
    float: left;
    display: block;
    color: black;
    text-align: center;
    padding: 16px 0px;
    text-decoration: none;
    font-size: 17px;
  }

  .navbar a:hover {
    background: #f1f1f1;
    color: black;
  }

  .navbar a.active {
    /*background-color: #04AA6D;*/
    color: rgb(213, 22, 165);
  }

  .main {
    padding: 16px;
    margin-bottom: 30px;
  }
</style>

<body style="margin: 0; padding:0; height: 100vh; width: 100%; background-color: #c862a2;">




  <div
    style="height: 30vh; background-color: #c862a2; display: flex; justify-content: flex-start; align-items: center; padding: 0vh 3vh 0vh 5vh; ">

    <div style="display: flex; flex-direction: column;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 20px;"><span class="font"
          style="font-size: 63px; color: beige; display: flex; align-items: center;"> Memo</span>
        <img style="width: 35% ;" src="./img/goal.png">
      </div>
      <span
        style="display: flex; flex-direction: column; font-size: 16px; font-family: Arial, Helvetica, sans-serif; color: #e0a7cb;">Let's
        make your study plan a success.</span>
    </div>
  </div>
  <div id="all_subject"
    style="height: 70vh; width:100%; background-color: rgb(255, 255, 255); border-radius: 20px 20px 0px 0px; display: flex; justify-content: center; align-items: baseline;">
    <div class="grid-container">
      <div class="grid-item"><a href="english.html"><img src="img/1.jpg "
            style="width: 10vh; height:10vh; border-radius: 10px; box-shadow: 0px 0px 5px 0px #7f7f7f;"></a><span
          style="display: flex; justify-content: center; font-size: 17px; ">English</span></div>
      <div class="grid-item"><a href="thai.html"><img src="img/2.jpg "
            style="width: 10vh; height:10vh; border-radius: 10px; box-shadow: 0px 0px 5px 0px #7f7f7f;"></a><span
          style="display: flex; justify-content: center; font-size: 17px; ">Thai</span></div>
      <div class="grid-item"><a href="math.html"><img src="img/3.jpg "
            style="width: 10vh; height:10vh; border-radius: 10px; box-shadow: 0px 0px 5px 0px #7f7f7f;"></a><span
          style="display: flex; justify-content: center; font-size: 17px; ">Math</span></div>
      <div class="grid-item"><a href="science.html"><img src="img/4.jpg "
            style="width: 10vh; height:10vh; border-radius: 10px; box-shadow: 0px 0px 5px 0px #7f7f7f;"></a><span
          style="display: flex; justify-content: center; font-size: 17px; ">Science</span></div>
      <div class="grid-item"><a href="social.html"><img src="img/social.png "
            style="width: 10vh; height:10vh; border-radius: 10px; box-shadow: 0px 0px 5px 0px #7f7f7f;"></a><span
          style="display: flex; justify-content: center; font-size: 17px; ">Social studies</span></div>
      <div class="grid-item"><a href="physics.html"><img src="img/6.jpg "
            style="width: 10vh; height:10vh; border-radius: 10px; box-shadow: 0px 0px 5px 0px #7f7f7f;"></a><span
          style="display: flex; justify-content: center; font-size: 17px; ">Physics</span></div>
      <div class="grid-item"><a href="chemistry.html"><img src="img/7.jpg "
            style="width: 10vh; height:10vh; border-radius: 10px; box-shadow: 0px 0px 5px 0px #7f7f7f;"></a><span
          style="display: flex; justify-content: center; font-size: 17px; ">Chemistry</span></div>
      <div class="grid-item"><a href="biology.html"><img src="img/8.jpg "
            style="width: 10vh; height:10vh; border-radius: 10px; box-shadow: 0px 0px 5px 0px #7f7f7f;"></a><span
          style="display: flex; justify-content: center; font-size: 17px; ">Biology</span></div>
      <div class="grid-item"><a href="gatpat.html"><img src="img/9.jpg "
            style="width: 10vh; height:10vh; border-radius: 10px; box-shadow: 0px 0px 5px 0px #7f7f7f;"></a><span
          style="display: flex; justify-content: center; font-size: 17px; ">Gat / Pat</span></div>

      <div id="addsubject" onclick="add_subject()" class="grid-item">
        <img src="https://cdn.discordapp.com/attachments/973798986207092738/1084867237447487579/Untitled_design-2.png"
          style="width: 10vh; height:10vh; border-radius: 10px; box-shadow: 0px 0px 5px 0px #7f7f7f;">
        <span style="display: flex; justify-content: center; font-size: 17px; ">add subject</span>
      </div>

    </div>
  </div>
  <div class="navbar">
    <a href="timer.html" style="width: 20%; "><img style="width: 40px;" src="./img/timer_navbar.png"></a>
    <a href="postfile.html" style="width: 20%;"><img style="width: 40px;" src="./img/note_navbar.png"></a>
    <a href="home.html " style="width: 20%; background-color: whitesmoke;"><img style="width: 40px;"
        src="./img/home_navbar.png"></a>
    <a href="Todo.html" style="width: 20%;"><img style="width: 40px;" src="./img/pencilicon.png"></a>
    <a href="setting.html" style="width: 20%;"><img style="width: 40px;" src="./img/shut-down.png"></a>
  </div>

  <!-- The Modal -->
  <div id="myModal" class="modal">

    <!-- Modal content -->
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <form>
        <label for="subject">Subject:</label>
        <input type="text" id="subject_text" name="subject"><br><br>
        <!-- <label for="file">Choose a file:</label> -->
        <!-- <input type="file" id="file" name="file"><br><br> -->
        <button type="button" onclick="submitForm(id_forChange,subject_text.value)">Submit</button>
      </form>
    </div>

  </div>
  <!-- ====== dynamic -->
  <div id="modal_subject_add" class="modal_subjectadd">
    <div class="add" onclick="openModalGrade()">
      <img class="addvector" src="./img/Vector.png">
    </div>

    <header style="background: #c862a2">
      <div style="display: flex; flex-direction: row;">
        <h1 id="title_subject">English</h1><img style="width: 60px; height: 60px;" src="./img/engicon.png">
      </div>

    </header>
    <div
      style="position : relative ; bottom: 0; background-color: white;height: 80vh; width: 100vw; display: inline-flex; flex-direction: column; align-items: center; ">
      <!-- <div class="add" onclick="openModalGrade()">
			<img class="addvector" src="./img/Vector.png">
		</div> -->
      <div id='subject_grade'>
        <div>
          <div class="slide-grade">
            <div class="circle-grade">
              <div id="text_grade" class="grade-text">A</div>
            </div>
            <div class="gread-bg-grade-text-center">
              <div class="grade-text-title">12 Tense</div>
              <div>Score 90/100</div>
            </div>
            <div id="grade_percent"
              style="font-size: 20px; font-weight: 600; top: 30%;left: 90%; transform: translate(-50%,-50%); position: absolute;">
              90%</div>
          </div>
        </div>
        <div>
          <div class="slide-grade">
            <div class="circle-grade">
              <div id="text_grade2" class="grade-text">A</div>
            </div>
            <div class="gread-bg-grade-text-center">
              <div class="grade-text-title">12 Tense</div>
              <div>Score 90/100</div>
            </div>
            <div id="grade_percent2"
              style="font-size: 20px; font-weight: 600; top: 30%;left: 90%; transform: translate(-50%,-50%); position: absolute;">
              90%</div>
          </div>
        </div>
      </div>
    </div>

    <div>
      <div class="navbar">
        <a href="timer.html" style="width: 20%;"><img style="width: 40px; " src="./img/timer_navbar.png"></a>
        <a href="postfile.html" style="width: 20%;"><img style="width: 40px;" src="./img/note_navbar.png"></a>
        <a href="home.html" style="width: 20%;"><img style="width: 40px;" src="./img/home_navbar.png"></a>
        <a href="Todo.html" style="width: 20%;"><img style="width: 40px;" src="./img/pencilicon.png"></a>
        <a href="setting.html" style="width: 20%;"><img style="width: 40px;" src="./img/setting_navbar.png"></a>
      </div>
    </div>

  </div>
  <div id="modal_grade1" class="modal-main">
    <div class="modal-subject">
      <div class="menu-top">
        <div onclick="closeModalGrade()"><img class="img-close-svg" src="./img/Vector.svg" alt=""></div>
        <div>คำนวณ</div>
        <div onclick="saveGrade()">บันทึก</div>
      </div>
      <hr>
      <div class="subject-save">
        <div class="input1">
          <div>หัวข้อ</div>
          <input id="save1" type="text">
        </div>
        <div class="input1 i2">
          <div>จำนวนข้อทั้งหมด</div>
          <input id="save2" type=" text">
        </div>
        <div class="input1 i3 red">
          <div>จำนวนข้อที่ถูกต้อง</div>
          <input id="save3" type=" text">
        </div>
        <br>
        <div id="warning1" class="warning1">จำนวนข้อที่ถูกต้องมากกว่าข้อทั้งหมด</div>
      </div>

    </div>

  </div>

</body>

</html>
<script src="./js/profile.js"></script>

<script src="./js/timer.js"></script>

<script>
  let id_forChange = ''
  function add_subject() {
    console.log('add_subject function called');
    var newDiv = document.createElement('div');
    let id_elem = uuid()
    newDiv.innerHTML = `
    <div onclick='openModal()' class="grid-item"><img src="https://cdn.discordapp.com/attachments/973798986207092738/1084878856277721098/Untitled_design-3.png"
          style="width: 10vh; height:10vh; border-radius: 10px; box-shadow: 0px 0px 5px 0px #7f7f7f;">
          <span id="${id_elem}" style="display: flex; justify-content: center; font-size: 17px; ">
            empty
          </span>
      </div>`;
    addsubject.insertAdjacentHTML('beforebegin', newDiv.innerHTML);
    openModal(id_elem)
    id_forChange = document.getElementById(id_elem)
  }
  render_menu()
  function render_menu() {

    const token = localStorage.getItem('token')
    const payload = {
      token: token,
    }

    fetch(localStorage.getItem('ip') + '/api/select/subject', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    })
      .then(response => response.json())
      .then(data => {

        data = data.data
        data.forEach(element => {
          console.log(element)
          let newDiv = document.createElement('div');
          newDiv.innerHTML = `
    <div onclick='open_subject_add_di("${element.subject}")' class="grid-item"><img src="https://cdn.discordapp.com/attachments/973798986207092738/1084878856277721098/Untitled_design-3.png"
          style="width: 10vh; height:10vh; border-radius: 10px; box-shadow: 0px 0px 5px 0px #7f7f7f;">
          <span id="" style="display: flex; justify-content: center; font-size: 17px; ">
            ${element.subject}
          </span>
      </div>`;
          addsubject.insertAdjacentHTML('beforebegin', newDiv.innerHTML);
        });
      })
      .catch(error => console.error(error))
  }
  function uuid() {
    // Generate a random string of characters
    var randStr = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
    // Generate a timestamp string
    var timestamp = new Date().getTime().toString(36);
    // Concatenate the random string and timestamp, separated by a hyphen
    var uuid = randStr + '_' + timestamp;
    // Return the UUID
    return uuid;
  }

  // Get the modal
  var modal = document.getElementById("myModal");

  // Get the button that opens the modal
  var btn = document.getElementsByTagName("button")[0];

  // Get the <span> element that closes the modal
  var span = document.getElementsByClassName("close")[0];

  // When the user clicks the button, open the modal 
  function openModal() {
    modal.style.display = "block";
  }

  // When the user clicks on <span> (x), close the modal
  function closeModal() {
    modal.style.display = "none";
  }

  // When the user clicks the Submit button, submit the form
  function submitForm(id, value = "test11") {
    id.innerText = value
    const token = localStorage.getItem('token')
    const subject = value

    const payload = {
      token: token,
      subject: subject
    }

    fetch(localStorage.getItem('ip') + '/api/add-subject', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    })
      .then(response => response.json())
      .then(data => console.log(data))
      .catch(error => console.error(error))
  }

</script>

<script>
  //คิดเกรด

  getCalData()
  function openModalGrade() {
    modal_grade1.classList.add('open')
  }
  function closeModalGrade() {
    modal_grade1.classList.remove('open')
    getCalData()
  }
  //save grade ทั้งหมด
  async function saveGrade() {
    let input1 = save1.value
    let input2 = save2.value
    let input3 = save3.value
    //ตรวจสอบว่า input1 input2 input3 มีค่าไหม
    if (input1 && input2 && input3 && parseFloat(input3) <= parseFloat(input2)) {
      try {
        warning1.classList.remove('open')
        save3.classList.remove('red')
        let jsondata = {
          subject: input1,
          num_all: parseFloat(input2),
          num_correct: parseFloat(input3)
        }
        const response = await fetch(localStorage.getItem('ip') + '/api/subject/insert', {
          method: 'POST',
          headers: {
            "Accept": "*/*",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            token: localStorage.getItem('token'),
            subject: subject_title,
            data: jsondata
          })
        })
        const data = await response.json()
        console.log(data)
        if (data.msg === 'success') {
          closeModalGrade()
          save1.value = ''
          save2.value = ''
          save3.value = ''
        } else {
          alert('something err')
        }
      } catch (err) {
        console.log(err)
      }
    } else if (input3 > input2) {
      alert('จำนวนข้อมากเกินไป')
      warning1.classList.add('open')
      save3.classList.add('red')
    } else {
      alert('กรุณากรอกข้อมูลให้ครบ')
    }
  }
  async function getCalData() {
    let headersList = {
      "Accept": "*/*",
      "Content-Type": "application/json"
    }

    let bodyContent = JSON.stringify({
      "token": localStorage.getItem('token')
    });

    let response = await fetch(localStorage.getItem('ip') + "/api/subject/"+subject_title, {
      method: "POST",
      body: bodyContent,
      headers: headersList
    });

    let data = await response.json();
    console.log(data);
    const PERCENT_GRADE = 100
    if (data.msg === 'success') {
      data = data.data
      console.log('new :', data)
      let html = ``
      data.slice(0).reverse().map(data => {
        const cal_percent = () => {
          let full = parseFloat(data.ref2)
          let correct = parseFloat(data.ref3)
          return correct / full * PERCENT_GRADE
        }
        const cal_grade = () => {

          if (cal_percent() >= 80 && cal_percent() <= 100) {
            return 'A'
          } else if (cal_percent() >= 70 && cal_percent() <= 79) {
            return 'B'
          } else if (cal_percent() >= 60 && cal_percent() <= 69) {
            return 'C'
          }
          else if (cal_percent() >= 50 && cal_percent() <= 59) {
            return 'D'
          } else if (cal_percent() >= 0 && cal_percent() <= 49) {
            return 'F'
          } else {
            return 'e' // err code
          }
        }
        html += `
				<div>
				<div class="slide-grade">
					<div class="circle-grade">
						<div id="text_grade" class="grade-text">${cal_grade()}</div>
					</div>
					<div class="gread-bg-grade-text-center">
						<div class="grade-text-title">${data.ref1}</div>
						<div>Score ${data.ref3}/${data.ref2}</div>
					</div>
					<div id="grade_percent"
						style="font-size: 20px; font-weight: 600; top: 30%;left: 90%; transform: translate(-50%,-50%); position: absolute;">
						${cal_percent().toFixed(0)}%</div>
				</div>
			</div>
				`
      })
      subject_grade.innerHTML = html

    } else {
      alert('บางอย่างผิดพลาด')
    }

  }
  var subject_title = ''
  function open_subject_add_di(st) {
    subject_title = st
    title_subject.innerText =  subject_title
    modal_subject_add.classList.add('open')
    setTimeout(getCalData,100)
  }
</script>