<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link
		href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Poppins:wght@500&family=Rubik:wght@500&display=swap"
		rel="stylesheet">
	<title>POST file</title>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<link rel="stylesheet" href="setting.css" />
	<link rel="stylesheet" href="./css/postfile.css">
	<link rel="stylesheet" href="download.css" />
</head>
<style>
	.navbar a {
		float: left;
		display: block;
		color: black;
		text-align: center;
		padding: 16px 0px;
		text-decoration: none;
		font-size: 17px;
	}

	.navbar a:hover {
		background: #f1f1f1;
		color: black;
	}

	.navbar a.active {
		/*background-color: #04AA6D;*/
		color: rgb(213, 22, 165);
	}
</style>

<body>
	<div class="main-body">
		<div class="body">
			<div class="search">
				<input type="text" onclick="render_post()" onkeyup="filtersSearch(this)" name="" id="searchpost">
				<img class="icon-search" src="./img/iconsearch.svg"></img>
				<img id="swap111" onclick="swapupload(this)" style="object-fit: contain; " src="./img/uploadaim2.png"
					alt="upload">
				<img id="fev_image" src="./img/fev222.png" onclick="fillter_Fev(this)" class="imgfev" alt="">
			</div>
			<div style="overflow: scroll;height: 84vh;">
				<!-- grid layout  -->
				<div id="showallpost" class="grid-container open">
					<!-- content -->
					<!-- <div class="card-container">
						<div class="box" >
							<img class="img-inbox" src=localStorage.getItem('ip')+"/1676087960612-bear.png" alt="">
						</div>
						<div class="container-content">
							<div class="content">
								<span>file upload</span>
								<span style="text-align: start;">upload file by : Username</span>
							</div>
							<span>
								<img id="id1" class="img-star" onclick="fev(this)" src="./img/starnonfull.svg" alt="">
							</span>
						</div>
					</div>
					<div class="card-container">
						<div class="box" '>
							<img class="img-inbox" src=localStorage.getItem('ip')+"/1676087960612-bear.png" alt="">
						</div>
						<div class="container-content">
							<div class="content">
								<span>file upload</span>
								<span style="text-align: start;">upload file by : Username</span>
							</div>
							<span>
								<img id="id1" class="img-star" onclick="fev(this)" src="./img/starnonfull.svg" alt="">
							</span>
						</div>
					</div>

					 -->
				</div>
				<!-- upload file -->
				<div class="upload-container">
					<div class="b1">
						<label id="" style="margin-right: 5px;" for="head-uploadfile">หัวข้อ</label>
						<input id="upload_getvalue" class="update-input" type="text" name='head-uploadfile'>
					</div>
					<div class="b1 more">
						<label id="" for="head-uploadfile">เลือกไฟล์ ( png , jpg , pdf )</label>
						<input style="margin-top: 5px;" type="file" onchange="preview()" id="fileInput" multiple>
					</div>
					<div id="upload_imgs" class="b1 more grid-img-show close"></div>
					<div id="upload_mock" class="">
						<!-- <div>
							<img src="" alt="">
						</div>
						<div>
							<img src="" alt="">
						</div>
						<div>
							<img src="" alt="">
						</div>
						<div>
							<img src="" alt="">
						</div>
						<div>
							<img src="" alt="">
						</div> -->
					</div>
					<div class="b1">
						<span class="fn1-a">แฮชแท็ก ( เลือกอย่างน้อย1 )</span>
						<div class="grid-img-2">
							<div onclick="makeSelectBorder(this)">#ไทย</div>
							<div onclick="makeSelectBorder(this)">#อังกฤษ</div>
							<div onclick="makeSelectBorder(this)">#คณิต</div>
							<div onclick="makeSelectBorder(this)">#เคมี</div>
							<div onclick="makeSelectBorder(this)">#สังคม</div>
							<div onclick="makeSelectBorder(this)">#วิทย์</div>
							<div onclick="makeSelectBorder(this)">#gatpat</div>
							<div onclick="makeSelectBorder(this)">#ฟิสิกส์</div>
							<div onclick="makeSelectBorder(this)">#ประวัติ</div>
							<div onclick="makeSelectBorder(this)">#อื่นๆ</div>
						</div>
					</div>
					<div style="margin-top: 50px; display: flex;justify-content: center;">
						<div id="uploadButton" class="btnby-upload-file">
							Upload file
						</div>
					</div>

				</div>
			</div>

		</div>
	</div>
	<div>
		<div class="navbar">
			<a href="timer.html" style="width: 20%;"><img style="width: 40px; " src="./img/timer_navbar.png"></a>
			<a href="postfile.html" style="width: 20%; background-color: whitesmoke"><img style="width: 40px;"
					src="./img/note_navbar.png"></a>
			<a href="home.html" style="width: 20%;"><img style="width: 40px;" src="./img/home_navbar.png"></a>
			<a href="Todo.html" style="width: 20%;"><img style="width: 40px;" src="./img/pencilicon.png"></a>
			<a href="setting.html" style="width: 20%;"><img style="width: 40px;" src="./img/setting_navbar.png"></a>
		</div>
	</div>
	<div id="downloadpage" style="background-color: white;display: none;width: 100%; " class="downloadpage">
		<div style="display: flex; height: 5vh; flex-direction: row; align-items: center;">
			<div style="width: 50%; padding-left: 10px;"
				onclick="downloadpage.style.display = 'none';Download_all_path = [];">
				<span>close</span>
			</div>
			<div onclick="downloadImage(For_Download_Image)" style="width: 50%; text-align: end;padding-right: 10px;">
				<span>download</span>
			</div>
		</div>

		<div id="showoimgdownload2" class="slideshow-container">

			<div class="mySlides fade">
				<div class="numbertext">1 / 3</div>
				<img src="./img/testpic1.jpg" style="width:100%; height: 80vh;">
				<!-- <div class="text">Caption Text</div> -->
			</div>

			<div class="mySlides fade">
				<div class="numbertext">2 / 3</div>
				<img src="./img/testpic2.jpg" style="width:100%; height: 80vh;">
				<div class="text">Caption Two</div>
			</div>

			<div class="mySlides fade">
				<div class="numbertext">3 / 3</div>
				<img src="./img/testpic3.jpg" style="width:100%; height: 80vh;">
				<div class="text">Caption Three</div>
			</div>

			<a class="prev" onclick="plusSlides(-1)">❮</a>
			<a class="next" onclick="plusSlides(1)">❯</a>

		</div>


		<div id="showoimgdownload" style="margin-top: 10px;display: flex;overflow: scroll;" class="swipe">
			<img class="borderimge1 open" style="width: 22%; height: 12vh;" src="./img/1.jpg">
			<img class="borderimge1" style="width: 22%; height: 12vh;" src="./img/1.jpg">
			<img class="borderimge1" style="width: 22%; height: 12vh;" src="./img/1.jpg">
			<img class="borderimge1" style="width: 22%; height: 12vh;" src="./img/1.jpg">
			<img class="borderimge1" style="width: 22%; height: 12vh;" src="./img/1.jpg">
		</div>
	</div>

</body>

</html>
<script src="main.js"></script>

<script>
	let Download_all_path = []
	// script dowload.js
	// ---------------------------------------------------------------------------
	let For_Download_Image = ''
	let slideIndex = 1;
	showSlides(slideIndex);

	function plusSlides(n) {
		showSlides(slideIndex += n);
	}

	function currentSlide(n) {
		showSlides(slideIndex = n);
	}
	function showSlides(n) {
		let i;
		let slides = document.getElementsByClassName("mySlides");
		let dots = document.getElementsByClassName("dot");
		if (n > slides.length) { slideIndex = 1 }
		if (n < 1) { slideIndex = slides.length }
		for (i = 0; i < slides.length; i++) {
			slides[i].style.display = "none";
			document.querySelector(`#showoimgdownload > img:nth-child(${i + 1})`).classList.add('close')
		}
		for (i = 0; i < dots.length; i++) {
			dots[i].className = dots[i].className.replace(" active", "");
		}
		document.querySelector(`#showoimgdownload > img:nth-child(${slideIndex})`).classList.remove('close')
		let image = document.querySelector(`#showoimgdownload2 > div:nth-child(${slideIndex}) > img`)
		For_Download_Image = image.src
		slides[slideIndex - 1].style.display = "block";
	}
	// ------------------------------------------------------------------------------------------

	let formData = ''
	async function swapupload(e) {
		let swap = document.querySelector('.grid-container').getAttribute('class')
		let post = document.querySelector('.grid-container')
		let upload = document.querySelector('.upload-container')
		if (switch_fev) {
			await fillter_Fev(fev_image)
		}
		if (swap.includes('open')) {
			post.classList.remove('open')
			upload.classList.add('open')
			formData = new FormData();
			console.log('new FormData')
			upload_imgs.innerHTML = ''
			fileInput.value = ''
			upload_mock.classList.remove('close')
			upload_imgs.classList.add('close')
			upload_getvalue.value = ''
			e.src = './img/uploadaim.png'
		} else {
			e.src = './img/uploadaim2.png'
			post.classList.add('open')
			upload.classList.remove('open')
		}
	}
	async function fev(id, obj, containner_id) {
		let star = document.getElementById(id.id).src
		star.includes('fevfullstar') ? document.getElementById(id.id).src = './img/starnonfull.svg' : document.getElementById(id.id).src = './img/fevfullstar.svg'
		let headersList = {
			"Accept": "*/*", "Content-Type": "application/json"
		}
		const fetchgetFev = async (type) => {
			// console.log('obj', obj)
			let response = await fetch(localStorage.getItem('ip') + '/api/fev/' + type, {
				headers: headersList,
				method: "POST",
				body: JSON.stringify({
					token: localStorage.getItem('token'),
					id: obj
				})
			})
			let data = await response.json()
			return data
		}
		if (star.includes('fevfullstar')) {
			if (containner_id) {
				containner_id.style.display = 'none'
			}
			fetchgetFev('off')
		} else {
			fetchgetFev('on')
		}
	}

	function preview() {
		let obj_length = event.target.files.length
		let input = event.target
		let html = upload_imgs.innerHTML
		for (let i = 0; i < obj_length; i++) {
			formData.append('file', input.files[i]);
			// console.log('formData', formData)
			let src = URL.createObjectURL(event.target.files[i]);
			html += `<div>
							<img class='img-width' src="${src}" alt="">
					</div>`
		}
		upload_imgs.innerHTML = html
		upload_imgs.classList.remove('close')
		upload_mock.classList.add('close')

	}

	const button = document.querySelector('#uploadButton');
	button.addEventListener('click', (event) => {
		event.preventDefault();
		formData.append('user', localStorage.getItem('user'));
		formData.append('head', upload_getvalue.value);
		formData.append('hashtages', MAJOR_FOR_SEND);
		fetch(localStorage.getItem('ip') + '/api/upload', {
			method: 'POST',
			body: formData
		})
			.then(response => response.json())
			.then(data => {
				try {
					console.log(1)
					if (data.msg == 'success') {
						alert('uploads file สำเร็จ')
						swapupload(swap111)
						render_post()
					} else {
						alert('uploads file ไม่สำเร็จกรุณาลองใหม่')
						swapupload(swap111)
						render_post()
					}
				} catch (error) {
					console.log(2)
					alert('มีบางอย่างทำการผิดพลาด')
					swapupload(swap111)
					console.log(data);
					render_post()
				}
			})
			.catch(error => {
				console.log(3)
				console.log(error)
				swapupload(swap111)
				render_post()
			});
	});
	function filtersSearch(e) {
		let data = GLOBAL_POST_DATA
		let fillter_fev = GLOBAL_FEV_DATA
		let html = ''
		let search_text = e.value
		data.reverse().map(post => {
			
			let download_count = post.download_count
			let user_del = localStorage.getItem('user') === post.writer ? `<img style="width: 15px;margin-left:5px" class="" onclick="swal_remove(${post.id})" src="./img/del.svg" alt="">` : ''
			if (post.hashtag.includes(search_text)) {
				let srcimg1 = post.path.split(',')[0]
				let fev = fillter_fev.includes(post.id) ? './img/fevfullstar.svg' : './img/starnonfull.svg'
				html += `<div class="card-container">
						<div class="box" onclick='showdownload(${JSON.stringify(post)})'>
							<img class="img-inbox" src=${localStorage.getItem('ip')}/${srcimg1} alt="">
						</div>
						<div class="container-content">
							<div class="content">
								<span>${post.title}</span>
								<span style="text-align: start;">user : ${post.writer}</span>
							</div>
							<span class="toflex">
								<img id="${'img' + post.id}" class="img-star" onclick="fev(this,${post.id})" src="${fev}" alt="">
								${user_del}
							</span>
						</div>
						<div class = "mini-download">${download_count} downloads</div>
					</div>`
			}
		})
		showallpost.innerHTML = html
	}
	render_post()
	let GLOBAL_POST_DATA = ''
	let GLOBAL_FEV_DATA = ''
	async function render_post() {
		try {
			let headersList = {
				"Accept": "*/*",
				"Content-Type": "application/json"
			}
			let response = await fetch(localStorage.getItem('ip') + "/api/show/post", {
				method: "GET",
				headers: headersList
			});

			let data = await response.json();

			data = data.data
			GLOBAL_POST_DATA = data
			let html = ''
			let response_fev = await fetch(localStorage.getItem('ip') + "/api/show/fev", {
				method: "POST",
				body: JSON.stringify({
					token: localStorage.getItem('token')
				}),
				headers: headersList
			});

			let data_fev = await response_fev.json();
			let fillter_fev = data_fev.data
			fillter_fev = fillter_fev.filter(data => {
				return data.status == 'on'
			}).map(d => d.ud_id)
			GLOBAL_FEV_DATA = fillter_fev
			data.reverse().map(post => {
				console.log(post)
				let download_count = post.download_count
				let user_del = localStorage.getItem('user') === post.writer ? `<img style="width: 15px;margin-left:5px" class="" onclick="swal_remove(${post.id})" src="./img/del.svg" alt="">` : ''
				let srcimg1 = post.path.split(',')[0]
				let src = localStorage.getItem('ip') + '/' + srcimg1
				// console.log(src)
				let fev = fillter_fev.includes(post.id) ? './img/fevfullstar.svg' : './img/starnonfull.svg'
				html += `<div class="card-container">
						<div class="box" onclick='showdownload(${JSON.stringify(post)})'>
							<img class="img-inbox" src=${src} alt="">
						</div>
						<div class="container-content">
							<div class="content">
								<span>${post.title}</span>
								<span style="text-align: start;">user : ${post.writer}</span>
							</div>
							<span class="toflex">
								<img id="${'img' + post.id}" class="img-star" onclick="fev(this,${post.id})" src="${fev}" alt="">
								${user_del}
							</span>
						</div>
						<div class = "mini-download">${download_count} downloads</div>
					</div>`
			})
			showallpost.innerHTML = html
		}
		catch (err) {
			console.log(err)
			alert('something err')
		}
	}
	function clickImage(n) {
		console.log('check click image ', n)
		let check_between = ITEM_AFTER - n
		console.log('check check_between ', check_between)
		if (ITEM_AFTER > n) {
			console.log('back')
			plusSlides(check_between * -1)
		} else if (ITEM_AFTER < n) {
			console.log('forward')
			plusSlides(Math.abs(check_between))
		}
		ITEM_AFTER = n

		// for (let index = 0; index < check_between; index++) {
		// 	const element = array[index];

		// }
	}
	let ITEM_AFTER = 1
	var ud_id = 0;
	function showdownload(obj) {
		ud_id = obj.id
		let imgToArr = obj.path.split(',')
		let html = '' //image bar
		let html2 = ''//main image
		let allnum = imgToArr.length
		imgToArr.forEach((e, index) => {
			html += `<img onclick="clickImage(${index + 1})" class='borderimge1' style="width: 22%; height: 12vh;" src="./${e}">`
		});
		imgToArr.forEach((e, index) => {
			Download_all_path.push(e)
			html2 += `
			<div class="mySlides fade">
				<div class="numbertext">${index + 1} / ${allnum}</div>
				<img src="./${e}" style="width:100%; height: 80vh;">
				<!-- <div class="text">Caption Text</div> -->
			</div>`

		});
		html2 += `<a class="prev" onclick="plusSlides(-1)">❮</a>
			<a class="next" onclick="plusSlides(1)">❯</a>`
		// console.log(imgToArr)
		downloadpage.style.display = ''//open
		showoimgdownload.innerHTML = html
		showoimgdownload2.innerHTML = html2
		setTimeout(() => {
			plusSlides(1)
		}, 50)
		setTimeout(() => {
			plusSlides(-1)
		}, 50)
	}
	async function removeByuser(id) {
		let headersList = {
			"Accept": "*/*",
			"Content-Type": "application/json"
		}
		try {
			let response = await fetch(localStorage.getItem('ip') + "/api/del/post", {
				method: "POST",
				body: JSON.stringify({
					token: localStorage.getItem('token'),
					'id': id
				}),
				headers: headersList
			});

			let data = await response.json();
			console.log('xxxxxxxxxx', data)
			if (data.msg === 'success') {
				console.log('yyy')
				setTimeout(() => {
					render_post()
				}, 1000)
				return true
			} else {
				return false
			}
		} catch (error) {
			return false
		}

	}
	// let Download_all_path = []

	function downloadImage(url) {
		Download_all_path.forEach(e => {
			url = e
			var link = document.createElement("a");
			link.download = url.slice(-20);
			link.href = url;
			link.click();
		})
		Download_all_path = []
		update_count_download()
		render_post()
		
	}
	function update_count_download(){
		const url_api = localStorage.getItem('ip') + '/api/download-count';
		const token = localStorage.getItem('token');
		const data = { token ,id : ud_id };

		fetch(url_api, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify(data)
		})
			.then(response => response.json())
			.then(result => {
				console.log(result)
			})
			.catch(error => { 
				alert('somethin err') 
			});
	}
	let switch_fev = false
	async function fillter_Fev(e) {
		await render_post()
		let checkupload = document.querySelector('.upload-container').className.includes('open')
		if (checkupload) {
			await swapupload(swap111)
			switch_fev = false
		}
		switch_fev = !switch_fev
		switch_fev ? e.src = './img/fev111.png' : e.src = './img/fev222.png'

		let html = ''
		let fillter_fev = ''
		fillter_fev = GLOBAL_FEV_DATA
		let data = GLOBAL_POST_DATA
		console.log('switch_fev', switch_fev)
		if (switch_fev) {
			data.reverse().map(post => {
				
				let download_count = post.download_count
				let user_del = localStorage.getItem('user') === post.writer ? `<img style="width: 15px;margin-left:5px" class="" onclick="swal_remove(${post.id})" src="./img/del.svg" alt="">` : ''
				let srcimg1 = post.path.split(',')[0]
				let fev = fillter_fev.includes(post.id) ? './img/fevfullstar.svg' : './img/starnonfull.svg'
				if (fillter_fev.includes(post.id)) {
					html += `<div id='post_container${post.id}' class="card-container">
						<div class="box" onclick='showdownload(${JSON.stringify(post)})'>
							<img class="img-inbox" src=${localStorage.getItem('ip')}/${srcimg1} alt="">
						</div>
						<div class="container-content">
							<div class="content">
								<span>${post.title}</span>
								<span style="text-align: start;">user : ${post.writer}</span>
							</div>
							<span class="toflex">
								<img id="${'img' + post.id}" class="img-star" onclick="fev(this,${post.id},post_container${post.id})" src="${fev}" alt="">
								${user_del}
							</span>
						</div>
						<div class = "mini-download">${download_count} downloads</div>
					</div>`
				} else {
					html += ''
				}
			})
			showallpost.innerHTML = html
		} else {
			render_post()
		}
		let check_open_upload = []
		showallpost.classList.forEach(e => check_open_upload.push(e))
		if (!check_open_upload.includes('open')) {
			console.log('xxx')
			swapupload(swap111)
		}
	}
	let MAJOR_FOR_SEND = []
	function makeSelectBorder(e) {
		let textContent = e.textContent
		if (MAJOR_FOR_SEND.includes(textContent)) {
			var index = MAJOR_FOR_SEND.indexOf(textContent);
			if (index !== -1) {
				MAJOR_FOR_SEND.splice(index, 1);
				e.classList.remove('make-border')
			}
			console.log(MAJOR_FOR_SEND)
		} else {
			MAJOR_FOR_SEND.push(textContent)
			e.classList.add('make-border')
		}
		console.log(MAJOR_FOR_SEND)
	}
	function swal_remove(id) {
		console.log('swall_id =>', id)
		const swalWithBootstrapButtons = Swal.mixin({
			customClass: {
				confirmButton: 'btn btn-success',
				cancelButton: 'btn btn-danger'
			},
			buttonsStyling: false
		})

		swalWithBootstrapButtons.fire({
			title: 'Are you sure?',
			text: "You won't be able to revert this!",
			icon: 'warning',
			showCancelButton: true,
			confirmButtonText: 'Yes, delete it!',
			cancelButtonText: 'No, cancel!',
			reverseButtons: true
		}).then((result) => {
			if (result.isConfirmed) {
				if (removeByuser(id)) {
					swalWithBootstrapButtons.fire(
						'Deleted!',
						'Your file has been deleted.',
						'success'
					)
				} else {
					alert('บางอย่างทำงานผิดพลาด')
				}

			} else if (
				/* Read more about handling dismissals below */
				result.dismiss === Swal.DismissReason.cancel
			) {
				swalWithBootstrapButtons.fire(
					'Cancelled',
					'Your imaginary file is safe :)',
					'error'
				)
			}
		})

	}
</script>
<script src="./js/timer.js"></script>